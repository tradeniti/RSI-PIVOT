I HAVE A TRADING STRATEGY. I WANT TO HAVE AN COMPREHENSIVE BACKTEST REPORT WITH CHARTS, THE TRADING DATA. SPECIALLY WHEN WE BOUTH / SELD AND WHEN WE TOOK EXIT. THE WORST PERFORMER. THE CAHRT THAT WILL SHOW THE BUY ARROW AND SELL ARROW SO I CAN VISUALLY SEE WHEN WE BOUGHT AND WHEN WE SOLD. SO I WILL SHRAE ALL THE FILES SO YOU CAN HELP ME BY GIVEING THE COMPFLETE UPDATRED FILE CODES SO I CAN GENERATE THE VESUALLY AMEZING BAKTEST REPORTS.

i have a few files like : main.py, class_file.py, report_generator.py, template.html. i ahve other fiels too but that files are data fiels and those file do nto need editing.

main.py 
# main.py - V2 IMPROVED (BEST STRATEGY)


import pandas as pd
import json
from class_file import TradingStrategy
from report_generator import ReportGenerator
from datetime import datetime


def calculate_roi_on_invested_capital(trades):
Â  Â  """Calculate ROI based on actual margin used"""
Â  Â  total_margin_used = 0
Â  Â  total_pnl = 0
Â  Â  
Â  Â  for trade in trades:
Â  Â  Â  Â  total_margin_used += trade['margin_used']
Â  Â  Â  Â  total_pnl += trade['total_pnl']
Â  Â  
Â  Â  avg_margin_per_trade = total_margin_used / len(trades) if trades else 0
Â  Â  roi_on_invested = (total_pnl / total_margin_used * 100) if total_margin_used > 0 else 0
Â  Â  
Â  Â  return {
Â  Â  Â  Â  'total_margin_used': total_margin_used,
Â  Â  Â  Â  'avg_margin_per_trade': avg_margin_per_trade,
Â  Â  Â  Â  'roi_on_invested': roi_on_invested,
Â  Â  Â  Â  'total_pnl': total_pnl
Â  Â  }


def save_text_summary(strategy, trades, invested_roi, output_file='backtest_summary.txt'):
Â  Â  """Save detailed backtest summary to text file"""
Â  Â  with open(output_file, 'w', encoding='utf-8') as f:
Â  Â  Â  Â  f.write("="*80 + "\n")
Â  Â  Â  Â  f.write("BACKTEST COMPLETE - SILVERMIC (1kg) - V2 IMPROVED\n")
Â  Â  Â  Â  f.write("="*80 + "\n")
Â  Â  Â  Â  f.write(f"Initial Capital: â‚¹{strategy.initial_capital:,.2f}\n")
Â  Â  Â  Â  f.write(f"Final Capital: â‚¹{strategy.available_capital:,.2f}\n")
Â  Â  Â  Â  f.write(f"Total Trades: {len(trades)}\n")
Â  Â  Â  Â  
Â  Â  Â  Â  if trades:
Â  Â  Â  Â  Â  Â  wins = len([t for t in trades if t['pnl_before_expense'] > 0])
Â  Â  Â  Â  Â  Â  total_pnl_before_expense = sum(t['pnl_before_expense'] for t in trades)
Â  Â  Â  Â  Â  Â  total_expenses = sum(t['expense'] for t in trades)
Â  Â  Â  Â  Â  Â  total_pnl = sum(t['total_pnl'] for t in trades)
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  f.write(f"Wins: {wins} | Losses: {len(trades) - wins} | Win Rate: {(wins/len(trades)*100):.2f}%\n")
Â  Â  Â  Â  Â  Â  f.write(f"PnL Before Expenses: â‚¹{total_pnl_before_expense:,.2f}\n")
Â  Â  Â  Â  Â  Â  f.write(f"Total Expenses: â‚¹{total_expenses:,.2f} (@ â‚¹{strategy.expense_per_trade}/trade)\n")
Â  Â  Â  Â  Â  Â  f.write(f"Net PnL: â‚¹{total_pnl:,.2f}\n")
Â  Â  Â  Â  Â  Â  f.write(f"ROI (on Capital): {((strategy.available_capital - strategy.initial_capital) / strategy.initial_capital * 100):.2f}%\n")
Â  Â  Â  Â  Â  Â  f.write(f"Avg ROI (per trade on margin): {sum(t['roi'] for t in trades) / len(trades):.2f}%\n")
Â  Â  Â  Â  Â  Â  f.write(f"Max Drawdown: {strategy.max_drawdown:.2f}%\n")
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  f.write("\n Strategy Breakdown:\n")
Â  Â  Â  Â  Â  Â  for strat_type in ['PRIMARY', 'SECONDARY', 'REENTRY-1', 'REENTRY-2', 'SHORT']:
Â  Â  Â  Â  Â  Â  Â  Â  strat_trades = [t for t in trades if t['type'] == strat_type]
Â  Â  Â  Â  Â  Â  Â  Â  if strat_trades:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  strat_wins = len([t for t in strat_trades if t['pnl_before_expense'] > 0])
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  strat_pnl = sum(t['total_pnl'] for t in strat_trades)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  f.write(f" Â {strat_type}: {len(strat_trades)} trades, {strat_wins} wins ({strat_wins/len(strat_trades)*100:.1f}%), PnL: â‚¹{strat_pnl:,.2f}\n")
Â  Â  Â  Â  
Â  Â  Â  Â  f.write("="*80 + "\n\n")
Â  Â  Â  Â  
Â  Â  Â  Â  # ROI explanation
Â  Â  Â  Â  f.write("="*80 + "\n")
Â  Â  Â  Â  f.write("ğŸ’° ROI EXPLANATION\n")
Â  Â  Â  Â  f.write("="*80 + "\n")
Â  Â  Â  Â  f.write(f"Total Capital in Account: â‚¹{strategy.initial_capital:,} (insurance/margin)\n")
Â  Â  Â  Â  f.write(f"Total Margin Actually Used: â‚¹{invested_roi['total_margin_used']:,.2f}\n")
Â  Â  Â  Â  f.write(f"Avg Margin per Trade: â‚¹{invested_roi['avg_margin_per_trade']:,.2f}\n\n")
Â  Â  Â  Â  f.write(f"ğŸ“Š ROI on Total Capital: {((strategy.available_capital - strategy.initial_capital) / strategy.initial_capital * 100):.2f}%\n")
Â  Â  Â  Â  f.write(f"ğŸ¯ ROI on Invested Capital: {invested_roi['roi_on_invested']:.2f}%\n\n")
Â  Â  Â  Â  f.write("Note: ROI on Invested = Return on actual money used in trades\n")
Â  Â  Â  Â  f.write(" Â  Â  Â ROI on Capital = Return on full account balance\n")
Â  Â  Â  Â  f.write("="*80 + "\n\n")
Â  Â  Â  Â  
Â  Â  Â  Â  # Strategy details
Â  Â  Â  Â  f.write("="*80 + "\n")
Â  Â  Â  Â  f.write("ğŸ“Š STRATEGY DETAILS\n")
Â  Â  Â  Â  f.write("="*80 + "\n")
Â  Â  Â  Â  f.write("V2 - IMPROVED Strategy Features:\n")
Â  Â  Â  Â  f.write(" Â âœ… Dynamic trailing SL on PRIMARY\n")
Â  Â  Â  Â  f.write(" Â âœ… Dual REENTRY (REENTRY-1 + REENTRY-2)\n")
Â  Â  Â  Â  f.write(" Â âœ… â‚¹10/trade expense (80% reduction from original)\n")
Â  Â  Â  Â  f.write(" Â âœ… Exit 11 days before contract expiry\n")
Â  Â  Â  Â  f.write(" Â âœ… SHORT after PRIMARY loss only\n")
Â  Â  Â  Â  f.write("="*80 + "\n\n")
Â  Â  Â  Â  
Â  Â  Â  Â  # Key metrics
Â  Â  Â  Â  profit_per_trade = total_pnl / len(trades) if trades else 0
Â  Â  Â  Â  f.write("="*80 + "\n")
Â  Â  Â  Â  f.write("ğŸ“ˆ KEY METRICS\n")
Â  Â  Â  Â  f.write("="*80 + "\n")
Â  Â  Â  Â  f.write(f"Profit per Trade: â‚¹{profit_per_trade:,.2f}\n")
Â  Â  Â  Â  f.write(f"Expense Ratio: {(total_expenses / total_pnl_before_expense * 100):.2f}%\n")
Â  Â  Â  Â  f.write(f"Capital Efficiency: {((total_pnl_before_expense - total_expenses) / total_pnl_before_expense * 100):.2f}%\n")
Â  Â  Â  Â  f.write(f"Profit Factor: {(sum(t['pnl_before_expense'] for t in trades if t['pnl_before_expense'] > 0) / abs(sum(t['pnl_before_expense'] for t in trades if t['pnl_before_expense'] < 0))):.2f}\n")
Â  Â  Â  Â  f.write(f"Peak Capital: â‚¹{strategy.peak_capital:,.2f}\n")
Â  Â  Â  Â  f.write("="*80 + "\n")
Â  Â  
Â  Â  print(f"âœ… Text summary saved to {output_file}")


def main():
Â  Â  print("="*80)
Â  Â  print("SILVERMIC (1KG) TRADING STRATEGY - V2 IMPROVED (BEST)")
Â  Â  print("="*80)
Â  Â  
Â  Â  # Load data
Â  Â  try:
Â  Â  Â  Â  df = pd.read_csv('data_new_updated.csv')
Â  Â  Â  Â  print(f"\nâœ… Loaded {len(df)} bars from data.csv")
Â  Â  Â  Â  print(f"ğŸ“… Date range: {df['Datetime'].iloc[0]} to {df['Datetime'].iloc[-1]}")
Â  Â  except FileNotFoundError:
Â  Â  Â  Â  print("\nâŒ Error: data.csv not found!")
Â  Â  Â  Â  return
Â  Â  
Â  Â  # Initialize strategy
Â  Â  initial_capital = 50000
Â  Â  expense_per_trade = 10
Â  Â  
Â  Â  strategy = TradingStrategy(
Â  Â  Â  Â  initial_capital=initial_capital,
Â  Â  Â  Â  expense_per_trade=expense_per_trade
Â  Â  )
Â  Â  
Â  Â  print(f"\nğŸ“Š V2 Strategy Configuration:")
Â  Â  print(f" Â â”œâ”€ Initial Capital: â‚¹{initial_capital:,}")
Â  Â  print(f" Â â”œâ”€ Contract: SILVERMIC (1kg)")
Â  Â  print(f" Â â”œâ”€ Margin: 10% of entry price")
Â  Â  print(f" Â â”œâ”€ Quantity: Always 1 lot")
Â  Â  print(f" Â â”œâ”€ Expense per trade: â‚¹{expense_per_trade}")
Â  Â  print(f" Â â”œâ”€ PRIMARY: Dynamic trailing SL âœ…")
Â  Â  print(f" Â â”œâ”€ REENTRY: Dual strategy âœ…")
Â  Â  print(f" Â â”œâ”€ SHORT: After PRIMARY loss only âœ…")
Â  Â  print(f" Â â””â”€ Exit before expiry: 11 days âœ…")
Â  Â  
Â  Â  print(f"\nğŸš€ Starting backtest...\n")
Â  Â  
Â  Â  # Run backtest
Â  Â  trades = strategy.run(df)
Â  Â  
Â  Â  if not trades:
Â  Â  Â  Â  print("\nâš ï¸ No trades executed!")
Â  Â  Â  Â  return
Â  Â  
Â  Â  # Calculate ROI on invested capital
Â  Â  invested_roi = calculate_roi_on_invested_capital(trades)
Â  Â  
Â  Â  # Prepare data for saving
Â  Â  trades_data = {
Â  Â  Â  Â  'config': {
Â  Â  Â  Â  Â  Â  'initial_capital': initial_capital,
Â  Â  Â  Â  Â  Â  'expense_per_trade': expense_per_trade,
Â  Â  Â  Â  Â  Â  'contract': 'SILVERMIC',
Â  Â  Â  Â  Â  Â  'lot_size': '1kg',
Â  Â  Â  Â  Â  Â  'margin_percentage': 10,
Â  Â  Â  Â  Â  Â  'backtest_date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
Â  Â  Â  Â  Â  Â  'data_file': 'data_new_updated.csv',
Â  Â  Â  Â  Â  Â  'total_bars': len(df),
Â  Â  Â  Â  Â  Â  'version': 'V2 - IMPROVED (BEST)',
Â  Â  Â  Â  Â  Â  'date_range': {
Â  Â  Â  Â  Â  Â  Â  Â  'start': df['Datetime'].iloc[0],
Â  Â  Â  Â  Â  Â  Â  Â  'end': df['Datetime'].iloc[-1]
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  'improvements': {
Â  Â  Â  Â  Â  Â  Â  Â  'primary_dynamic_sl': True,
Â  Â  Â  Â  Â  Â  Â  Â  'dual_reentry_strategy': True,
Â  Â  Â  Â  Â  Â  Â  Â  'expiry_days_before': 11,
Â  Â  Â  Â  Â  Â  Â  Â  'reduced_expense': True
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },
Â  Â  Â  Â  'summary': {
Â  Â  Â  Â  Â  Â  'initial_capital': initial_capital,
Â  Â  Â  Â  Â  Â  'final_capital': strategy.available_capital,
Â  Â  Â  Â  Â  Â  'total_trades': len(trades),
Â  Â  Â  Â  Â  Â  'winning_trades': len([t for t in trades if t['pnl_before_expense'] > 0]),
Â  Â  Â  Â  Â  Â  'losing_trades': len([t for t in trades if t['pnl_before_expense'] < 0]),
Â  Â  Â  Â  Â  Â  'win_rate': (len([t for t in trades if t['pnl_before_expense'] > 0]) / len(trades) * 100) if trades else 0,
Â  Â  Â  Â  Â  Â  'total_pnl_before_expense': sum(t['pnl_before_expense'] for t in trades),
Â  Â  Â  Â  Â  Â  'total_expenses': sum(t['expense'] for t in trades),
Â  Â  Â  Â  Â  Â  'net_pnl': sum(t['total_pnl'] for t in trades),
Â  Â  Â  Â  Â  Â  'roi_on_capital': ((strategy.available_capital - initial_capital) / initial_capital * 100),
Â  Â  Â  Â  Â  Â  'roi_on_invested': invested_roi['roi_on_invested'],
Â  Â  Â  Â  Â  Â  'total_margin_used': invested_roi['total_margin_used'],
Â  Â  Â  Â  Â  Â  'avg_margin_per_trade': invested_roi['avg_margin_per_trade'],
Â  Â  Â  Â  Â  Â  'avg_roi_per_trade': sum(t['roi'] for t in trades) / len(trades) if trades else 0,
Â  Â  Â  Â  Â  Â  'max_drawdown': strategy.max_drawdown,
Â  Â  Â  Â  Â  Â  'peak_capital': strategy.peak_capital,
Â  Â  Â  Â  Â  Â  'biggest_win': max(t['pnl_before_expense'] for t in trades),
Â  Â  Â  Â  Â  Â  'biggest_loss': min(t['pnl_before_expense'] for t in trades)
Â  Â  Â  Â  },
Â  Â  Â  Â  'strategy_breakdown': {
Â  Â  Â  Â  Â  Â  'PRIMARY': {
Â  Â  Â  Â  Â  Â  Â  Â  'trades': len([t for t in trades if t['type'] == 'PRIMARY']),
Â  Â  Â  Â  Â  Â  Â  Â  'wins': len([t for t in trades if t['type'] == 'PRIMARY' and t['pnl_before_expense'] > 0]),
Â  Â  Â  Â  Â  Â  Â  Â  'pnl': sum(t['total_pnl'] for t in trades if t['type'] == 'PRIMARY')
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  'SECONDARY': {
Â  Â  Â  Â  Â  Â  Â  Â  'trades': len([t for t in trades if t['type'] == 'SECONDARY']),
Â  Â  Â  Â  Â  Â  Â  Â  'wins': len([t for t in trades if t['type'] == 'SECONDARY' and t['pnl_before_expense'] > 0]),
Â  Â  Â  Â  Â  Â  Â  Â  'pnl': sum(t['total_pnl'] for t in trades if t['type'] == 'SECONDARY')
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  'REENTRY-1': {
Â  Â  Â  Â  Â  Â  Â  Â  'trades': len([t for t in trades if t['type'] == 'REENTRY-1']),
Â  Â  Â  Â  Â  Â  Â  Â  'wins': len([t for t in trades if t['type'] == 'REENTRY-1' and t['pnl_before_expense'] > 0]),
Â  Â  Â  Â  Â  Â  Â  Â  'pnl': sum(t['total_pnl'] for t in trades if t['type'] == 'REENTRY-1')
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  'REENTRY-2': {
Â  Â  Â  Â  Â  Â  Â  Â  'trades': len([t for t in trades if t['type'] == 'REENTRY-2']),
Â  Â  Â  Â  Â  Â  Â  Â  'wins': len([t for t in trades if t['type'] == 'REENTRY-2' and t['pnl_before_expense'] > 0]),
Â  Â  Â  Â  Â  Â  Â  Â  'pnl': sum(t['total_pnl'] for t in trades if t['type'] == 'REENTRY-2')
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  'SHORT': {
Â  Â  Â  Â  Â  Â  Â  Â  'trades': len([t for t in trades if t['type'] == 'SHORT']),
Â  Â  Â  Â  Â  Â  Â  Â  'wins': len([t for t in trades if t['type'] == 'SHORT' and t['pnl_before_expense'] > 0]),
Â  Â  Â  Â  Â  Â  Â  Â  'pnl': sum(t['total_pnl'] for t in trades if t['type'] == 'SHORT')
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },
Â  Â  Â  Â  'trades': trades
Â  Â  }
Â  Â  
Â  Â  # Save JSON
Â  Â  with open('trades_report.json', 'w') as f:
Â  Â  Â  Â  json.dump(trades_data, f, indent=2)
Â  Â  print(f"âœ… Trades saved to trades_report.json")
Â  Â  
Â  Â  # Save CSV
Â  Â  trades_df = pd.DataFrame(trades)
Â  Â  trades_df.to_csv('trades_output.csv', index=False)
Â  Â  print(f"âœ… Trades saved to trades_output.csv")
Â  Â  
Â  Â  # â­â­â­ SAVE TEXT SUMMARY â­â­â­
Â  Â  print(f"\nğŸ“ Generating text summary...")
Â  Â  save_text_summary(strategy, trades, invested_roi, 'backtest_summary.txt')
Â  Â  
Â  Â  # Generate HTML Report
Â  Â  print(f"\nğŸ“Š Generating HTML report...")
Â  Â  report_gen = ReportGenerator()
Â  Â  output_file = report_gen.generate_report('trades_report.json', 'backtest_report.html')
Â  Â  
Â  Â  # Print sample trades
Â  Â  print(f"\n{'='*80}")
Â  Â  print("ğŸ“‹ SAMPLE TRADES (Last 10):")
Â  Â  print(f"{'='*80}")
Â  Â  for trade in trades[-10:]:
Â  Â  Â  Â  pnl_symbol = "ğŸŸ¢" if trade['pnl_before_expense'] > 0 else "ğŸ”´"
Â  Â  Â  Â  print(f"{pnl_symbol} #{trade['trade_number']:3d} | {trade['exit_date']} | "
Â  Â  Â  Â  Â  Â  Â  f"{trade['type']:11} | Entry:â‚¹{trade['entry']:8.2f} Exit:â‚¹{trade['exit']:8.2f} | "
Â  Â  Â  Â  Â  Â  Â  f"PnL:â‚¹{trade['total_pnl']:+8.2f} | {trade['exit_reason']}")
Â  Â  
Â  Â  print(f"\n{'='*80}")
Â  Â  print(f"âœ¨ BACKTEST COMPLETE - V2 IMPROVED (BEST STRATEGY)")
Â  Â  print(f"{'='*80}")
Â  Â  print(f"ğŸ“„ JSON Report: trades_report.json")
Â  Â  print(f"ğŸ“Š CSV Export: trades_output.csv")
Â  Â  print(f"ğŸ“ Text Summary: backtest_summary.txt")
Â  Â  print(f"ğŸŒ HTML Report: {output_file}")
Â  Â  print(f"{'='*80}")
Â  Â  print(f"\nğŸ¯ RESULTS SUMMARY:")
Â  Â  print(f" Â ROI: {((strategy.available_capital - initial_capital) / initial_capital * 100):.2f}%")
Â  Â  print(f" Â Win Rate: {(len([t for t in trades if t['pnl_before_expense'] > 0]) / len(trades) * 100):.2f}%")
Â  Â  print(f" Â Max Drawdown: {strategy.max_drawdown:.2f}%")
Â  Â  print(f" Â Final Capital: â‚¹{strategy.available_capital:,.2f}")
Â  Â  print(f"{'='*80}\n")


if __name__ == "__main__":
Â  Â  main()


class_file.py
# class_file.py - V2 IMPROVED (BEST STRATEGY)


import pandas as pd
import json
from datetime import datetime
from pathlib import Path


class TradingStrategy:
Â  Â  def __init__(self, initial_capital=50000, expense_per_trade=10):
Â  Â  Â  Â  """
Â  Â  Â  Â  V2 - IMPROVED Strategy (BEST)
Â  Â  Â  Â  - Dynamic trailing SL on PRIMARY
Â  Â  Â  Â  - Dual REENTRY (REENTRY-1 + REENTRY-2)
Â  Â  Â  Â  - â‚¹10/trade expense
Â  Â  Â  Â  - Exit 11 days before expiry
Â  Â  Â  Â  """
Â  Â  Â  Â  self.initial_capital = initial_capital
Â  Â  Â  Â  self.available_capital = initial_capital
Â  Â  Â  Â  self.peak_capital = initial_capital
Â  Â  Â  Â  self.max_drawdown = 0
Â  Â  Â  Â  self.capital_depleted = False
Â  Â  Â  Â  self.expense_per_trade = expense_per_trade
Â  Â  Â  Â  
Â  Â  Â  Â  # Position state
Â  Â  Â  Â  self.in_position = False
Â  Â  Â  Â  self.in_short = False
Â  Â  Â  Â  self.buy_entry = None
Â  Â  Â  Â  self.short_entry = None
Â  Â  Â  Â  self.stop_loss = None
Â  Â  Â  Â  self.short_sl = None
Â  Â  Â  Â  self.sl_stage = 0
Â  Â  Â  Â  self.position_quantity = 1
Â  Â  Â  Â  self.lot_size = 1
Â  Â  Â  Â  self.entry_date = None
Â  Â  Â  Â  self.margin_blocked = 0
Â  Â  Â  Â  
Â  Â  Â  Â  # Strategy states
Â  Â  Â  Â  self.primary_blocked = False
Â  Â  Â  Â  self.both_disabled = False
Â  Â  Â  Â  self.reentry1_disabled = False
Â  Â  Â  Â  self.last_profit = False
Â  Â  Â  Â  self.secondary_losses = 0
Â  Â  Â  Â  
Â  Â  Â  Â  # Trade log
Â  Â  Â  Â  self.trades = []
Â  Â  Â  Â  self.current_day = None
Â  Â  Â  Â  
Â  Â  Â  Â  # Track strategy type
Â  Â  Â  Â  self.current_is_primary = False
Â  Â  Â  Â  self.current_is_secondary = False
Â  Â  Â  Â  self.current_is_reentry1 = False
Â  Â  Â  Â  self.current_is_reentry2 = False
Â  Â  Â  Â  self.exit_reason = None
Â  Â  Â  Â  
Â  Â  Â  Â  # Top line history for REENTRY-2
Â  Â  Â  Â  self.top_line_history = []
Â  Â  Â  Â  
Â  Â  def calculate_indicators(self, df, fib_length=264):
Â  Â  Â  Â  """Calculate all indicators"""
Â  Â  Â  Â  df['Top_Line'] = df['close'].rolling(window=fib_length).max()
Â  Â  Â  Â  df['Bottom_Line'] = df['close'].rolling(window=fib_length).min()
Â  Â  Â  Â  df['Pivot_Line'] = df['Top_Line'] - 0.50 * (df['Top_Line'] - df['Bottom_Line'])
Â  Â  Â  Â  
Â  Â  Â  Â  df['Upper_Tolerance'] = df['Bottom_Line'] + (df['Bottom_Line'] * 0.004)
Â  Â  Â  Â  df['Lower_Tolerance'] = df['Bottom_Line'] - (df['Bottom_Line'] * 0.004)
Â  Â  Â  Â  df['Top_Upper'] = df['Top_Line'] + (df['Top_Line'] * 0.004)
Â  Â  Â  Â  df['Top_Lower'] = df['Top_Line'] - (df['Top_Line'] * 0.004)
Â  Â  Â  Â  
Â  Â  Â  Â  df['Recovery_Threshold'] = df['Pivot_Line'] + (df['Pivot_Line'] * 0.003)
Â  Â  Â  Â  df['Reentry_Threshold'] = df['Pivot_Line'] + (df['Pivot_Line'] * 0.002)
Â  Â  Â  Â  
Â  Â  Â  Â  # RSI
Â  Â  Â  Â  delta = df['close'].diff()
Â  Â  Â  Â  gain = delta.where(delta > 0, 0).rolling(window=14).mean()
Â  Â  Â  Â  loss = -delta.where(delta < 0, 0).rolling(window=14).mean()
Â  Â  Â  Â  rs = gain / loss
Â  Â  Â  Â  df['RSI'] = 100 - (100 / (1 + rs))
Â  Â  Â  Â  
Â  Â  Â  Â  df['SMA2'] = df['close'].rolling(window=2).mean()
Â  Â  Â  Â  
Â  Â  Â  Â  return df
Â  Â  
Â  Â  def calculate_margin_required(self, price):
Â  Â  Â  Â  return price * 0.10
Â  Â  
Â  Â  def is_expiry_week(self, current_date):
Â  Â  Â  Â  """Exit 11 days before 5th of Mar/May/Jul/Sep/Dec"""
Â  Â  Â  Â  expiry_months = [3, 5, 7, 9, 12]
Â  Â  Â  Â  if current_date.month not in expiry_months:
Â  Â  Â  Â  Â  Â  return False
Â  Â  Â  Â  if 1 <= current_date.day <= 5:
Â  Â  Â  Â  Â  Â  return True
Â  Â  Â  Â  if current_date.month in [2, 4, 6, 8, 11]:
Â  Â  Â  Â  Â  Â  next_month = current_date.month + 1
Â  Â  Â  Â  Â  Â  if next_month in expiry_months and current_date.day >= 22:
Â  Â  Â  Â  Â  Â  Â  Â  return True
Â  Â  Â  Â  return False
Â  Â  
Â  Â  def update_top_line_history(self, top_line_value):
Â  Â  Â  Â  self.top_line_history.append(top_line_value)
Â  Â  Â  Â  if len(self.top_line_history) > 10:
Â  Â  Â  Â  Â  Â  self.top_line_history.pop(0)
Â  Â  
Â  Â  def get_9th_top_line(self):
Â  Â  Â  Â  if len(self.top_line_history) >= 9:
Â  Â  Â  Â  Â  Â  return self.top_line_history[-9]
Â  Â  Â  Â  return None
Â  Â  
Â  Â  def check_primary_buy(self, row):
Â  Â  Â  Â  """PRIMARY: RSI 20-29 + in bottom zone"""
Â  Â  Â  Â  if self.in_position or self.in_short or self.primary_blocked or self.both_disabled or self.capital_depleted:
Â  Â  Â  Â  Â  Â  return False
Â  Â  Â  Â  rsi_ok = 20 <= row['RSI'] <= 29
Â  Â  Â  Â  price_ok = row['Lower_Tolerance'] <= row['close'] <= row['Upper_Tolerance']
Â  Â  Â  Â  margin_needed = self.calculate_margin_required(row['close'])
Â  Â  Â  Â  has_capital = self.available_capital >= margin_needed
Â  Â  Â  Â  return rsi_ok and price_ok and has_capital
Â  Â  
Â  Â  def check_secondary_buy(self, row, prev_row):
Â  Â  Â  Â  """SECONDARY: SMA2 cross + filters"""
Â  Â  Â  Â  if self.in_position or self.in_short or self.both_disabled or self.capital_depleted:
Â  Â  Â  Â  Â  Â  return False
Â  Â  Â  Â  sma_cross = (prev_row['SMA2'] <= prev_row['Upper_Tolerance'] and 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â row['SMA2'] > row['Upper_Tolerance'])
Â  Â  Â  Â  rsi_ok = row['RSI'] <= 75
Â  Â  Â  Â  distance_ok = (row['Pivot_Line'] - row['Upper_Tolerance']) >= 300
Â  Â  Â  Â  can_trade = self.primary_blocked or self.last_profit
Â  Â  Â  Â  margin_needed = self.calculate_margin_required(row['close'])
Â  Â  Â  Â  has_capital = self.available_capital >= margin_needed
Â  Â  Â  Â  return sma_cross and rsi_ok and distance_ok and can_trade and has_capital
Â  Â  
Â  Â  def check_reentry1_buy(self, row, prev_row, primary_buy, secondary_buy):
Â  Â  Â  Â  """REENTRY-1: Pivot + 0.2% crossover"""
Â  Â  Â  Â  if self.in_position or self.in_short or self.both_disabled or self.capital_depleted:
Â  Â  Â  Â  Â  Â  return False
Â  Â  Â  Â  if primary_buy or secondary_buy:
Â  Â  Â  Â  Â  Â  return False
Â  Â  Â  Â  if self.reentry1_disabled:
Â  Â  Â  Â  Â  Â  return False
Â  Â  Â  Â  margin_needed = self.calculate_margin_required(row['close'])
Â  Â  Â  Â  has_capital = self.available_capital >= margin_needed
Â  Â  Â  Â  if not has_capital:
Â  Â  Â  Â  Â  Â  return False
Â  Â  Â  Â  sma_cross = (prev_row['SMA2'] <= prev_row['Reentry_Threshold'] and 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â row['SMA2'] > row['Reentry_Threshold'])
Â  Â  Â  Â  safety = row['close'] < (row['Top_Line'] - 200)
Â  Â  Â  Â  return sma_cross and safety
Â  Â  
Â  Â  def check_reentry2_buy(self, row, prev_row, primary_buy, secondary_buy):
Â  Â  Â  Â  """REENTRY-2: 9th TOP_LINE breakout"""
Â  Â  Â  Â  if self.in_position or self.in_short or self.both_disabled or self.capital_depleted:
Â  Â  Â  Â  Â  Â  return False
Â  Â  Â  Â  if primary_buy or secondary_buy:
Â  Â  Â  Â  Â  Â  return False
Â  Â  Â  Â  if not self.reentry1_disabled:
Â  Â  Â  Â  Â  Â  return False
Â  Â  Â  Â  margin_needed = self.calculate_margin_required(row['close'])
Â  Â  Â  Â  has_capital = self.available_capital >= margin_needed
Â  Â  Â  Â  if not has_capital:
Â  Â  Â  Â  Â  Â  return False
Â  Â  Â  Â  ninth_top = self.get_9th_top_line()
Â  Â  Â  Â  if ninth_top is None:
Â  Â  Â  Â  Â  Â  return False
Â  Â  Â  Â  sma_cross = (prev_row['SMA2'] <= ninth_top and row['SMA2'] > ninth_top)
Â  Â  Â  Â  return sma_cross
Â  Â  
Â  Â  def enter_long(self, row, is_primary, is_secondary, is_reentry1, is_reentry2, idx, current_date):
Â  Â  Â  Â  """Execute long entry"""
Â  Â  Â  Â  self.margin_blocked = self.calculate_margin_required(row['close'])
Â  Â  Â  Â  self.in_position = True
Â  Â  Â  Â  self.buy_entry = row['close']
Â  Â  Â  Â  self.sl_stage = 1
Â  Â  Â  Â  self.entry_date = current_date
Â  Â  Â  Â  self.current_is_primary = is_primary
Â  Â  Â  Â  self.current_is_secondary = is_secondary
Â  Â  Â  Â  self.current_is_reentry1 = is_reentry1
Â  Â  Â  Â  self.current_is_reentry2 = is_reentry2
Â  Â  Â  Â  
Â  Â  Â  Â  if is_primary:
Â  Â  Â  Â  Â  Â  # PRIMARY: Dynamic trailing (starts at -500)
Â  Â  Â  Â  Â  Â  self.stop_loss = self.buy_entry - 500
Â  Â  Â  Â  Â  Â  trade_type = 'PRIMARY'
Â  Â  Â  Â  elif is_secondary:
Â  Â  Â  Â  Â  Â  if self.secondary_losses >= 1:
Â  Â  Â  Â  Â  Â  Â  Â  self.stop_loss = row['Bottom_Line'] - 300
Â  Â  Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  Â  Â  self.stop_loss = row['Bottom_Line'] - 400
Â  Â  Â  Â  Â  Â  trade_type = 'SECONDARY'
Â  Â  Â  Â  elif is_reentry1:
Â  Â  Â  Â  Â  Â  self.stop_loss = row['Pivot_Line'] - 250
Â  Â  Â  Â  Â  Â  max_loss_sl = self.buy_entry - 500
Â  Â  Â  Â  Â  Â  self.stop_loss = max(self.stop_loss, max_loss_sl)
Â  Â  Â  Â  Â  Â  trade_type = 'REENTRY-1'
Â  Â  Â  Â  elif is_reentry2:
Â  Â  Â  Â  Â  Â  sl_option1 = self.buy_entry - 400
Â  Â  Â  Â  Â  Â  sl_option2 = row['Pivot_Line'] - 250
Â  Â  Â  Â  Â  Â  distance_to_pivot = abs(self.buy_entry - row['Pivot_Line'])
Â  Â  Â  Â  Â  Â  if distance_to_pivot < 300:
Â  Â  Â  Â  Â  Â  Â  Â  self.stop_loss = sl_option2
Â  Â  Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  Â  Â  self.stop_loss = sl_option1
Â  Â  Â  Â  Â  Â  trade_type = 'REENTRY-2'
Â  Â  Â  Â  
Â  Â  Â  Â  print(f"Bar {idx}: {trade_type} BUY â‚¹{self.buy_entry:.2f}, SL=â‚¹{self.stop_loss:.2f}")
Â  Â  
Â  Â  def update_trailing_sl(self, row):
Â  Â  Â  Â  """Update trailing stop loss - PRIMARY NOW DYNAMIC"""
Â  Â  Â  Â  if not self.in_position:
Â  Â  Â  Â  Â  Â  return
Â  Â  Â  Â  
Â  Â  Â  Â  if self.current_is_primary:
Â  Â  Â  Â  Â  Â  # V2: PRIMARY now trails dynamically like SECONDARY
Â  Â  Â  Â  Â  Â  if self.sl_stage == 1 and row['close'] >= (row['Pivot_Line'] - row['Pivot_Line'] * 0.004):
Â  Â  Â  Â  Â  Â  Â  Â  self.stop_loss = row['Bottom_Line'] - 200
Â  Â  Â  Â  Â  Â  Â  Â  self.sl_stage = 2
Â  Â  Â  Â  Â  Â  elif self.sl_stage == 2 and row['close'] >= (row['Top_Line'] - row['Top_Line'] * 0.004):
Â  Â  Â  Â  Â  Â  Â  Â  self.sl_stage = 3
Â  Â  Â  Â  Â  Â  if self.sl_stage == 3:
Â  Â  Â  Â  Â  Â  Â  Â  self.stop_loss = row['Pivot_Line'] - 250
Â  Â  Â  Â  
Â  Â  Â  Â  elif self.current_is_secondary:
Â  Â  Â  Â  Â  Â  if self.sl_stage == 1 and row['close'] >= (row['Pivot_Line'] - row['Pivot_Line'] * 0.004):
Â  Â  Â  Â  Â  Â  Â  Â  self.stop_loss = row['Bottom_Line'] - 200
Â  Â  Â  Â  Â  Â  Â  Â  self.sl_stage = 2
Â  Â  Â  Â  Â  Â  elif self.sl_stage == 2 and row['close'] >= (row['Top_Line'] - row['Top_Line'] * 0.004):
Â  Â  Â  Â  Â  Â  Â  Â  self.sl_stage = 3
Â  Â  Â  Â  Â  Â  if self.sl_stage == 3:
Â  Â  Â  Â  Â  Â  Â  Â  self.stop_loss = row['Pivot_Line'] - 250
Â  Â  Â  Â  
Â  Â  Â  Â  elif self.current_is_reentry1:
Â  Â  Â  Â  Â  Â  new_sl = row['Pivot_Line'] - 250
Â  Â  Â  Â  Â  Â  max_loss_sl = self.buy_entry - 500
Â  Â  Â  Â  Â  Â  new_sl = max(new_sl, max_loss_sl)
Â  Â  Â  Â  Â  Â  if new_sl > self.stop_loss:
Â  Â  Â  Â  Â  Â  Â  Â  self.stop_loss = new_sl
Â  Â  Â  Â  
Â  Â  Â  Â  elif self.current_is_reentry2:
Â  Â  Â  Â  Â  Â  new_sl = row['Pivot_Line'] - 250
Â  Â  Â  Â  Â  Â  if new_sl > self.stop_loss:
Â  Â  Â  Â  Â  Â  Â  Â  self.stop_loss = new_sl
Â  Â  
Â  Â  def check_expiry_exit(self, row, idx, current_date):
Â  Â  Â  Â  if not self.in_position:
Â  Â  Â  Â  Â  Â  return
Â  Â  Â  Â  if self.is_expiry_week(current_date):
Â  Â  Â  Â  Â  Â  self.exit_reason = "Contract Expiry (11 days)"
Â  Â  Â  Â  Â  Â  self._execute_exit(row, idx, current_date, row['close'], 'EXPIRY')
Â  Â  
Â  Â  def check_long_exit(self, row, idx, current_date):
Â  Â  Â  Â  if not self.in_position:
Â  Â  Â  Â  Â  Â  return
Â  Â  Â  Â  if row['low'] <= self.stop_loss:
Â  Â  Â  Â  Â  Â  if self.sl_stage == 3:
Â  Â  Â  Â  Â  Â  Â  Â  self.exit_reason = "Trailing Stop Loss"
Â  Â  Â  Â  Â  Â  elif self.sl_stage == 2:
Â  Â  Â  Â  Â  Â  Â  Â  self.exit_reason = "Stage 2 Stop Loss"
Â  Â  Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  Â  Â  self.exit_reason = "Initial Stop Loss"
Â  Â  Â  Â  Â  Â  self._execute_exit(row, idx, current_date, self.stop_loss, 'SL')
Â  Â  
Â  Â  def _execute_exit(self, row, idx, current_date, exit_price, exit_type):
Â  Â  Â  Â  pnl_per_lot = (exit_price - self.buy_entry) * self.lot_size
Â  Â  Â  Â  total_pnl = pnl_per_lot * self.position_quantity
Â  Â  Â  Â  pnl_before_expense = total_pnl
Â  Â  Â  Â  total_pnl -= self.expense_per_trade
Â  Â  Â  Â  
Â  Â  Â  Â  self.available_capital += total_pnl
Â  Â  Â  Â  self.peak_capital = max(self.peak_capital, self.available_capital)
Â  Â  Â  Â  drawdown = (self.peak_capital - self.available_capital) / self.peak_capital * 100 if self.peak_capital > 0 else 0
Â  Â  Â  Â  self.max_drawdown = max(self.max_drawdown, drawdown)
Â  Â  Â  Â  
Â  Â  Â  Â  if self.available_capital <= 0:
Â  Â  Â  Â  Â  Â  self.capital_depleted = True
Â  Â  Â  Â  
Â  Â  Â  Â  if pnl_before_expense > 0:
Â  Â  Â  Â  Â  Â  self.last_profit = True
Â  Â  Â  Â  Â  Â  self.secondary_losses = 0
Â  Â  Â  Â  Â  Â  if self.current_is_secondary or self.current_is_reentry1 or self.current_is_reentry2:
Â  Â  Â  Â  Â  Â  Â  Â  self.primary_blocked = False
Â  Â  Â  Â  Â  Â  if self.current_is_reentry2:
Â  Â  Â  Â  Â  Â  Â  Â  self.reentry1_disabled = False
Â  Â  Â  Â  Â  Â  status = 'PROFIT' if exit_type != 'EXPIRY' else 'PROFIT_EXPIRY'
Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  self.last_profit = False
Â  Â  Â  Â  Â  Â  if self.current_is_primary:
Â  Â  Â  Â  Â  Â  Â  Â  self.primary_blocked = True
Â  Â  Â  Â  Â  Â  Â  Â  self.secondary_losses = 0
Â  Â  Â  Â  Â  Â  Â  Â  if not self.capital_depleted:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  self.enter_short(row, idx, current_date)
Â  Â  Â  Â  Â  Â  Â  Â  status = 'PRIMARY_LOSS'
Â  Â  Â  Â  Â  Â  elif self.current_is_secondary:
Â  Â  Â  Â  Â  Â  Â  Â  self.secondary_losses += 1
Â  Â  Â  Â  Â  Â  Â  Â  if self.secondary_losses >= 2:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  self.both_disabled = True
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  self.reentry1_disabled = True
Â  Â  Â  Â  Â  Â  Â  Â  status = 'SECONDARY_LOSS'
Â  Â  Â  Â  Â  Â  elif self.current_is_reentry1:
Â  Â  Â  Â  Â  Â  Â  Â  self.reentry1_disabled = True
Â  Â  Â  Â  Â  Â  Â  Â  status = 'REENTRY1_LOSS'
Â  Â  Â  Â  Â  Â  elif self.current_is_reentry2:
Â  Â  Â  Â  Â  Â  Â  Â  status = 'REENTRY2_LOSS'
Â  Â  Â  Â  
Â  Â  Â  Â  if self.current_is_primary:
Â  Â  Â  Â  Â  Â  trade_type = 'PRIMARY'
Â  Â  Â  Â  elif self.current_is_secondary:
Â  Â  Â  Â  Â  Â  trade_type = 'SECONDARY'
Â  Â  Â  Â  elif self.current_is_reentry1:
Â  Â  Â  Â  Â  Â  trade_type = 'REENTRY-1'
Â  Â  Â  Â  elif self.current_is_reentry2:
Â  Â  Â  Â  Â  Â  trade_type = 'REENTRY-2'
Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  trade_type = 'UNKNOWN'
Â  Â  Â  Â  
Â  Â  Â  Â  roi = (pnl_before_expense / self.margin_blocked) * 100 if self.margin_blocked > 0 else 0
Â  Â  Â  Â  
Â  Â  Â  Â  print(f"Bar {idx}: {trade_type} EXIT â‚¹{exit_price:.2f}, PnL=â‚¹{total_pnl:.2f}")
Â  Â  Â  Â  
Â  Â  Â  Â  self.trades.append({
Â  Â  Â  Â  Â  Â  'trade_number': len(self.trades) + 1,
Â  Â  Â  Â  Â  Â  'bar': idx,
Â  Â  Â  Â  Â  Â  'entry_date': self.entry_date.strftime('%Y-%m-%d %H:%M:%S') if self.entry_date else '',
Â  Â  Â  Â  Â  Â  'exit_date': current_date.strftime('%Y-%m-%d'),
Â  Â  Â  Â  Â  Â  'type': trade_type,
Â  Â  Â  Â  Â  Â  'entry': self.buy_entry,
Â  Â  Â  Â  Â  Â  'exit': exit_price,
Â  Â  Â  Â  Â  Â  'quantity': self.position_quantity,
Â  Â  Â  Â  Â  Â  'pnl_per_lot': pnl_per_lot,
Â  Â  Â  Â  Â  Â  'pnl_before_expense': pnl_before_expense,
Â  Â  Â  Â  Â  Â  'expense': self.expense_per_trade,
Â  Â  Â  Â  Â  Â  'total_pnl': total_pnl,
Â  Â  Â  Â  Â  Â  'roi': roi,
Â  Â  Â  Â  Â  Â  'status': status,
Â  Â  Â  Â  Â  Â  'exit_reason': self.exit_reason,
Â  Â  Â  Â  Â  Â  'margin_used': self.margin_blocked,
Â  Â  Â  Â  Â  Â  'capital_after': self.available_capital,
Â  Â  Â  Â  Â  Â  'sl_stage': self.sl_stage,
Â  Â  Â  Â  Â  Â  'stop_loss': self.stop_loss
Â  Â  Â  Â  })
Â  Â  Â  Â  
Â  Â  Â  Â  self.in_position = False
Â  Â  Â  Â  self.buy_entry = None
Â  Â  Â  Â  self.stop_loss = None
Â  Â  Â  Â  self.sl_stage = 0
Â  Â  Â  Â  self.margin_blocked = 0
Â  Â  Â  Â  self.current_is_primary = False
Â  Â  Â  Â  self.current_is_secondary = False
Â  Â  Â  Â  self.current_is_reentry1 = False
Â  Â  Â  Â  self.current_is_reentry2 = False
Â  Â  Â  Â  self.exit_reason = None
Â  Â  
Â  Â  def enter_short(self, row, idx, current_date):
Â  Â  Â  Â  """Enter SHORT after PRIMARY loss only"""
Â  Â  Â  Â  self.margin_blocked = self.calculate_margin_required(row['close'])
Â  Â  Â  Â  self.in_short = True
Â  Â  Â  Â  self.short_entry = row['close']
Â  Â  Â  Â  self.short_sl = row['close'] + 400
Â  Â  Â  Â  self.entry_date = current_date
Â  Â  Â  Â  print(f"Bar {idx}: SHORT â‚¹{self.short_entry:.2f}, SL=â‚¹{self.short_sl:.2f}")
Â  Â  
Â  Â  def check_short_exit(self, row, prev_row, idx, current_date):
Â  Â  Â  Â  if not self.in_short:
Â  Â  Â  Â  Â  Â  return
Â  Â  Â  Â  
Â  Â  Â  Â  exit_triggered = False
Â  Â  Â  Â  exit_price = None
Â  Â  Â  Â  exit_reason = None
Â  Â  Â  Â  
Â  Â  Â  Â  if row['high'] >= self.short_sl:
Â  Â  Â  Â  Â  Â  exit_triggered = True
Â  Â  Â  Â  Â  Â  exit_price = self.short_sl
Â  Â  Â  Â  Â  Â  exit_reason = "Stop Loss"
Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  sma_cross = (prev_row['SMA2'] <= prev_row['Upper_Tolerance'] and 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â row['SMA2'] > row['Upper_Tolerance'])
Â  Â  Â  Â  Â  Â  pnl = self.short_entry - row['close']
Â  Â  Â  Â  Â  Â  if sma_cross and pnl > 0:
Â  Â  Â  Â  Â  Â  Â  Â  exit_triggered = True
Â  Â  Â  Â  Â  Â  Â  Â  exit_price = row['close']
Â  Â  Â  Â  Â  Â  Â  Â  exit_reason = "SMA2 Crossover"
Â  Â  Â  Â  
Â  Â  Â  Â  if exit_triggered:
Â  Â  Â  Â  Â  Â  pnl_per_lot = (self.short_entry - exit_price) * self.lot_size
Â  Â  Â  Â  Â  Â  pnl_before_expense = pnl_per_lot
Â  Â  Â  Â  Â  Â  total_pnl = pnl_before_expense - self.expense_per_trade
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  self.available_capital += total_pnl
Â  Â  Â  Â  Â  Â  self.peak_capital = max(self.peak_capital, self.available_capital)
Â  Â  Â  Â  Â  Â  drawdown = (self.peak_capital - self.available_capital) / self.peak_capital * 100 if self.peak_capital > 0 else 0
Â  Â  Â  Â  Â  Â  self.max_drawdown = max(self.max_drawdown, drawdown)
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if self.available_capital <= 0:
Â  Â  Â  Â  Â  Â  Â  Â  self.capital_depleted = True
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  status = 'PROFIT' if pnl_before_expense > 0 else 'LOSS'
Â  Â  Â  Â  Â  Â  roi = (pnl_before_expense / self.margin_blocked) * 100 if self.margin_blocked > 0 else 0
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  print(f"Bar {idx}: SHORT EXIT â‚¹{exit_price:.2f}, PnL=â‚¹{total_pnl:.2f}")
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  self.trades.append({
Â  Â  Â  Â  Â  Â  Â  Â  'trade_number': len(self.trades) + 1,
Â  Â  Â  Â  Â  Â  Â  Â  'bar': idx,
Â  Â  Â  Â  Â  Â  Â  Â  'entry_date': self.entry_date.strftime('%Y-%m-%d %H:%M:%S') if self.entry_date else '',
Â  Â  Â  Â  Â  Â  Â  Â  'exit_date': current_date.strftime('%Y-%m-%d'),
Â  Â  Â  Â  Â  Â  Â  Â  'type': 'SHORT',
Â  Â  Â  Â  Â  Â  Â  Â  'entry': self.short_entry,
Â  Â  Â  Â  Â  Â  Â  Â  'exit': exit_price,
Â  Â  Â  Â  Â  Â  Â  Â  'quantity': self.position_quantity,
Â  Â  Â  Â  Â  Â  Â  Â  'pnl_per_lot': pnl_per_lot,
Â  Â  Â  Â  Â  Â  Â  Â  'pnl_before_expense': pnl_before_expense,
Â  Â  Â  Â  Â  Â  Â  Â  'expense': self.expense_per_trade,
Â  Â  Â  Â  Â  Â  Â  Â  'total_pnl': total_pnl,
Â  Â  Â  Â  Â  Â  Â  Â  'roi': roi,
Â  Â  Â  Â  Â  Â  Â  Â  'status': status,
Â  Â  Â  Â  Â  Â  Â  Â  'exit_reason': exit_reason,
Â  Â  Â  Â  Â  Â  Â  Â  'margin_used': self.margin_blocked,
Â  Â  Â  Â  Â  Â  Â  Â  'capital_after': self.available_capital,
Â  Â  Â  Â  Â  Â  Â  Â  'sl_stage': 0,
Â  Â  Â  Â  Â  Â  Â  Â  'stop_loss': self.short_sl
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  self.in_short = False
Â  Â  Â  Â  Â  Â  self.short_entry = None
Â  Â  Â  Â  Â  Â  self.short_sl = None
Â  Â  Â  Â  Â  Â  self.margin_blocked = 0
Â  Â  
Â  Â  def daily_reset(self, current_date):
Â  Â  Â  Â  if self.current_day is None:
Â  Â  Â  Â  Â  Â  self.current_day = current_date
Â  Â  Â  Â  Â  Â  return
Â  Â  Â  Â  if current_date != self.current_day:
Â  Â  Â  Â  Â  Â  self.both_disabled = False
Â  Â  Â  Â  Â  Â  self.secondary_losses = 0
Â  Â  Â  Â  Â  Â  self.current_day = current_date
Â  Â  
Â  Â  def recovery_reset(self, row, prev_row):
Â  Â  Â  Â  sma_cross = (prev_row['SMA2'] <= prev_row['Recovery_Threshold'] and 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â row['SMA2'] > row['Recovery_Threshold'])
Â  Â  Â  Â  if self.both_disabled and sma_cross and not self.in_position and not self.in_short:
Â  Â  Â  Â  Â  Â  self.both_disabled = False
Â  Â  Â  Â  Â  Â  self.primary_blocked = False
Â  Â  Â  Â  Â  Â  self.secondary_losses = 0
Â  Â  Â  Â  Â  Â  self.reentry1_disabled = False
Â  Â  Â  Â  Â  Â  self.last_profit = False
Â  Â  
Â  Â  def run(self, df):
Â  Â  Â  Â  df = self.calculate_indicators(df)
Â  Â  Â  Â  
Â  Â  Â  Â  for i in range(264, len(df)):
Â  Â  Â  Â  Â  Â  if self.capital_depleted:
Â  Â  Â  Â  Â  Â  Â  Â  print(f"\nâŒ Trading stopped - Capital depleted")
Â  Â  Â  Â  Â  Â  Â  Â  break
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  row = df.iloc[i]
Â  Â  Â  Â  Â  Â  prev_row = df.iloc[i-1]
Â  Â  Â  Â  Â  Â  current_date = pd.to_datetime(row['Datetime']).date()
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  self.update_top_line_history(row['Top_Line'])
Â  Â  Â  Â  Â  Â  self.daily_reset(current_date)
Â  Â  Â  Â  Â  Â  self.recovery_reset(row, prev_row)
Â  Â  Â  Â  Â  Â  self.check_expiry_exit(row, i, current_date)
Â  Â  Â  Â  Â  Â  self.check_short_exit(row, prev_row, i, current_date)
Â  Â  Â  Â  Â  Â  self.check_long_exit(row, i, current_date)
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if self.in_position:
Â  Â  Â  Â  Â  Â  Â  Â  self.update_trailing_sl(row)
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if not self.in_position and not self.is_expiry_week(current_date):
Â  Â  Â  Â  Â  Â  Â  Â  primary_buy = self.check_primary_buy(row)
Â  Â  Â  Â  Â  Â  Â  Â  secondary_buy = self.check_secondary_buy(row, prev_row)
Â  Â  Â  Â  Â  Â  Â  Â  reentry1_buy = self.check_reentry1_buy(row, prev_row, primary_buy, secondary_buy)
Â  Â  Â  Â  Â  Â  Â  Â  reentry2_buy = self.check_reentry2_buy(row, prev_row, primary_buy, secondary_buy)
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if primary_buy:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  self.enter_long(row, True, False, False, False, i, current_date)
Â  Â  Â  Â  Â  Â  Â  Â  elif secondary_buy:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  self.enter_long(row, False, True, False, False, i, current_date)
Â  Â  Â  Â  Â  Â  Â  Â  elif reentry1_buy:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  self.enter_long(row, False, False, True, False, i, current_date)
Â  Â  Â  Â  Â  Â  Â  Â  elif reentry2_buy:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  self.enter_long(row, False, False, False, True, i, current_date)
Â  Â  Â  Â  
Â  Â  Â  Â  self._print_summary()
Â  Â  Â  Â  return self.trades
Â  Â  
Â  Â  def _print_summary(self):
Â  Â  Â  Â  print(f"\n{'='*80}")
Â  Â  Â  Â  print(f"BACKTEST COMPLETE - SILVERMIC (1kg) - V2 IMPROVED")
Â  Â  Â  Â  print(f"{'='*80}")
Â  Â  Â  Â  print(f"Initial Capital: â‚¹{self.initial_capital:,.2f}")
Â  Â  Â  Â  print(f"Final Capital: â‚¹{self.available_capital:,.2f}")
Â  Â  Â  Â  print(f"Total Trades: {len(self.trades)}")
Â  Â  Â  Â  
Â  Â  Â  Â  if self.trades:
Â  Â  Â  Â  Â  Â  wins = len([t for t in self.trades if t['pnl_before_expense'] > 0])
Â  Â  Â  Â  Â  Â  print(f"Wins: {wins} | Losses: {len(self.trades) - wins} | Win Rate: {(wins/len(self.trades)*100):.2f}%")
Â  Â  Â  Â  Â  Â  print(f"PnL Before Expenses: â‚¹{sum(t['pnl_before_expense'] for t in self.trades):,.2f}")
Â  Â  Â  Â  Â  Â  print(f"Total Expenses: â‚¹{sum(t['expense'] for t in self.trades):,.2f}")
Â  Â  Â  Â  Â  Â  print(f"Net PnL: â‚¹{sum(t['total_pnl'] for t in self.trades):,.2f}")
Â  Â  Â  Â  Â  Â  print(f"ROI: {((self.available_capital - self.initial_capital) / self.initial_capital * 100):.2f}%")
Â  Â  Â  Â  Â  Â  print(f"Max Drawdown: {self.max_drawdown:.2f}%")
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  print(f"\n Strategy Breakdown:")
Â  Â  Â  Â  Â  Â  for strategy in ['PRIMARY', 'SECONDARY', 'REENTRY-1', 'REENTRY-2', 'SHORT']:
Â  Â  Â  Â  Â  Â  Â  Â  strat_trades = [t for t in self.trades if t['type'] == strategy]
Â  Â  Â  Â  Â  Â  Â  Â  if strat_trades:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  strat_wins = len([t for t in strat_trades if t['pnl_before_expense'] > 0])
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  strat_pnl = sum(t['total_pnl'] for t in strat_trades)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  print(f" Â {strategy}: {len(strat_trades)} trades, {strat_wins} wins ({strat_wins/len(strat_trades)*100:.1f}%), PnL: â‚¹{strat_pnl:,.2f}")
Â  Â  Â  Â  
Â  Â  Â  Â  print(f"{'='*80}\n")

report_generator.py
# report_generator.py - SIMPLIFIED VERSION


import json
import pandas as pd
from datetime import datetime
from pathlib import Path


class ReportGenerator:
Â  Â  """Generate HTML reports from JSON trade data"""
Â  Â  
Â  Â  def __init__(self):
Â  Â  Â  Â  self.template_file = 'template.html'
Â  Â  
Â  Â  def load_trades_data(self, json_file):
Â  Â  Â  Â  """Load trades from JSON file"""
Â  Â  Â  Â  with open(json_file, 'r') as f:
Â  Â  Â  Â  Â  Â  return json.load(f)
Â  Â  
Â  Â  def calculate_monthly_stats(self, trades):
Â  Â  Â  Â  """Calculate monthly statistics"""
Â  Â  Â  Â  monthly_data = {}
Â  Â  Â  Â  
Â  Â  Â  Â  for trade in trades:
Â  Â  Â  Â  Â  Â  exit_date = datetime.strptime(trade['exit_date'], '%Y-%m-%d')
Â  Â  Â  Â  Â  Â  month_key = exit_date.strftime('%Y-%m')
Â  Â  Â  Â  Â  Â  month_name = exit_date.strftime('%B %Y')
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if month_key not in monthly_data:
Â  Â  Â  Â  Â  Â  Â  Â  monthly_data[month_key] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'month_name': month_name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'trades': [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'total_trades': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'winning_trades': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'losing_trades': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'pnl_before_expense': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'expenses': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'net_pnl': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'biggest_win': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'biggest_loss': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'primary_trades': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'secondary_trades': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'reentry1_trades': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'reentry2_trades': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'short_trades': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'primary_wins': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'secondary_wins': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'reentry1_wins': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'reentry2_wins': 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'short_wins': 0
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  month = monthly_data[month_key]
Â  Â  Â  Â  Â  Â  month['trades'].append(trade)
Â  Â  Â  Â  Â  Â  month['total_trades'] += 1
Â  Â  Â  Â  Â  Â  month['pnl_before_expense'] += trade['pnl_before_expense']
Â  Â  Â  Â  Â  Â  month['expenses'] += trade['expense']
Â  Â  Â  Â  Â  Â  month['net_pnl'] += trade['total_pnl']
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if trade['pnl_before_expense'] > 0:
Â  Â  Â  Â  Â  Â  Â  Â  month['winning_trades'] += 1
Â  Â  Â  Â  Â  Â  Â  Â  month['biggest_win'] = max(month['biggest_win'], trade['pnl_before_expense'])
Â  Â  Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  Â  Â  month['losing_trades'] += 1
Â  Â  Â  Â  Â  Â  Â  Â  month['biggest_loss'] = min(month['biggest_loss'], trade['pnl_before_expense'])
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  # Count by strategy type
Â  Â  Â  Â  Â  Â  trade_type = trade['type']
Â  Â  Â  Â  Â  Â  if trade_type == 'PRIMARY':
Â  Â  Â  Â  Â  Â  Â  Â  month['primary_trades'] += 1
Â  Â  Â  Â  Â  Â  Â  Â  if trade['pnl_before_expense'] > 0:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  month['primary_wins'] += 1
Â  Â  Â  Â  Â  Â  elif trade_type == 'SECONDARY':
Â  Â  Â  Â  Â  Â  Â  Â  month['secondary_trades'] += 1
Â  Â  Â  Â  Â  Â  Â  Â  if trade['pnl_before_expense'] > 0:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  month['secondary_wins'] += 1
Â  Â  Â  Â  Â  Â  elif trade_type == 'REENTRY-1':
Â  Â  Â  Â  Â  Â  Â  Â  month['reentry1_trades'] += 1
Â  Â  Â  Â  Â  Â  Â  Â  if trade['pnl_before_expense'] > 0:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  month['reentry1_wins'] += 1
Â  Â  Â  Â  Â  Â  elif trade_type == 'REENTRY-2':
Â  Â  Â  Â  Â  Â  Â  Â  month['reentry2_trades'] += 1
Â  Â  Â  Â  Â  Â  Â  Â  if trade['pnl_before_expense'] > 0:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  month['reentry2_wins'] += 1
Â  Â  Â  Â  Â  Â  elif trade_type == 'SHORT':
Â  Â  Â  Â  Â  Â  Â  Â  month['short_trades'] += 1
Â  Â  Â  Â  Â  Â  Â  Â  if trade['pnl_before_expense'] > 0:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  month['short_wins'] += 1
Â  Â  Â  Â  
Â  Â  Â  Â  # Calculate win rates
Â  Â  Â  Â  for month_key in monthly_data:
Â  Â  Â  Â  Â  Â  month = monthly_data[month_key]
Â  Â  Â  Â  Â  Â  month['win_rate'] = (month['winning_trades'] / month['total_trades'] * 100) if month['total_trades'] > 0 else 0
Â  Â  Â  Â  
Â  Â  Â  Â  return monthly_data
Â  Â  
Â  Â  def calculate_strategy_performance(self, trades):
Â  Â  Â  Â  """Calculate performance by strategy type"""
Â  Â  Â  Â  strategy_stats = {
Â  Â  Â  Â  Â  Â  'PRIMARY': {'trades': 0, 'wins': 0, 'losses': 0, 'pnl': 0, 'win_rate': 0},
Â  Â  Â  Â  Â  Â  'SECONDARY': {'trades': 0, 'wins': 0, 'losses': 0, 'pnl': 0, 'win_rate': 0},
Â  Â  Â  Â  Â  Â  'REENTRY-1': {'trades': 0, 'wins': 0, 'losses': 0, 'pnl': 0, 'win_rate': 0},
Â  Â  Â  Â  Â  Â  'REENTRY-2': {'trades': 0, 'wins': 0, 'losses': 0, 'pnl': 0, 'win_rate': 0},
Â  Â  Â  Â  Â  Â  'SHORT': {'trades': 0, 'wins': 0, 'losses': 0, 'pnl': 0, 'win_rate': 0}
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  for trade in trades:
Â  Â  Â  Â  Â  Â  strategy_type = trade['type']
Â  Â  Â  Â  Â  Â  if strategy_type in strategy_stats:
Â  Â  Â  Â  Â  Â  Â  Â  strategy_stats[strategy_type]['trades'] += 1
Â  Â  Â  Â  Â  Â  Â  Â  strategy_stats[strategy_type]['pnl'] += trade['total_pnl']
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if trade['pnl_before_expense'] > 0:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  strategy_stats[strategy_type]['wins'] += 1
Â  Â  Â  Â  Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  strategy_stats[strategy_type]['losses'] += 1
Â  Â  Â  Â  
Â  Â  Â  Â  # Calculate win rates
Â  Â  Â  Â  for strategy in strategy_stats:
Â  Â  Â  Â  Â  Â  total = strategy_stats[strategy]['trades']
Â  Â  Â  Â  Â  Â  if total > 0:
Â  Â  Â  Â  Â  Â  Â  Â  strategy_stats[strategy]['win_rate'] = (strategy_stats[strategy]['wins'] / total * 100)
Â  Â  Â  Â  
Â  Â  Â  Â  return strategy_stats
Â  Â  
Â  Â  def generate_report(self, json_file, output_html='backtest_report.html'):
Â  Â  Â  Â  """Generate HTML report from JSON data"""
Â  Â  Â  Â  
Â  Â  Â  Â  # Load data
Â  Â  Â  Â  data = self.load_trades_data(json_file)
Â  Â  Â  Â  config = data.get('config', {})
Â  Â  Â  Â  summary = data.get('summary', {})
Â  Â  Â  Â  trades = data.get('trades', [])
Â  Â  Â  Â  filter_analysis = data.get('filter_analysis', {})
Â  Â  Â  Â  
Â  Â  Â  Â  # Calculate additional stats
Â  Â  Â  Â  monthly_stats = self.calculate_monthly_stats(trades)
Â  Â  Â  Â  strategy_performance = self.calculate_strategy_performance(trades)
Â  Â  Â  Â  
Â  Â  Â  Â  # Read template
Â  Â  Â  Â  try:
Â  Â  Â  Â  Â  Â  with open(self.template_file, 'r', encoding='utf-8') as f:
Â  Â  Â  Â  Â  Â  Â  Â  template = f.read()
Â  Â  Â  Â  except FileNotFoundError:
Â  Â  Â  Â  Â  Â  print(f"âŒ Error: {self.template_file} not found!")
Â  Â  Â  Â  Â  Â  return None
Â  Â  Â  Â  
Â  Â  Â  Â  # Prepare data for template
Â  Â  Â  Â  report_data = {
Â  Â  Â  Â  Â  Â  'config': config,
Â  Â  Â  Â  Â  Â  'summary': summary,
Â  Â  Â  Â  Â  Â  'trades': trades,
Â  Â  Â  Â  Â  Â  'monthly_stats': monthly_stats,
Â  Â  Â  Â  Â  Â  'strategy_performance': strategy_performance,
Â  Â  Â  Â  Â  Â  'filter_analysis': filter_analysis,
Â  Â  Â  Â  Â  Â  'generation_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  # Convert to JSON for embedding in HTML
Â  Â  Â  Â  json_data = json.dumps(report_data, indent=2)
Â  Â  Â  Â  
Â  Â  Â  Â  # Replace placeholder in template
Â  Â  Â  Â  html_output = template.replace('{{REPORT_DATA}}', json_data)
Â  Â  Â  Â  
Â  Â  Â  Â  # Write output
Â  Â  Â  Â  with open(output_html, 'w', encoding='utf-8') as f:
Â  Â  Â  Â  Â  Â  f.write(html_output)
Â  Â  Â  Â  
Â  Â  Â  Â  print(f"âœ… HTML report generated: {output_html}")
Â  Â  Â  Â  return output_html

template.html 

<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>SILVERMIC V2 - Backtest Report</title>
Â  Â  
Â  Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
Â  Â  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
Â  Â  
Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --profit-color: #28a745;
Â  Â  Â  Â  Â  Â  --loss-color: #dc3545;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â  Â  Â  Â  Â  Â  padding: 20px 0 40px 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .stat-card {
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  Â  transition: transform 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .stat-card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-5px);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .stat-value {
Â  Â  Â  Â  Â  Â  font-size: 2rem;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  margin: 10px 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .stat-label {
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  opacity: 0.8;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 1px;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .profit-text { color: var(--profit-color) !important; }
Â  Â  Â  Â  .loss-text { color: var(--loss-color) !important; }
Â  Â  Â  Â  .badge-profit { background-color: var(--profit-color); }
Â  Â  Â  Â  .badge-loss { background-color: var(--loss-color); }
Â  Â  Â  Â  
Â  Â  Â  Â  [data-bs-theme="dark"] .stat-card {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255,255,255,0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  [data-bs-theme="light"] .stat-card {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(0,0,0,0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .theme-toggle {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 20px;
Â  Â  Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .hero-section {
Â  Â  Â  Â  Â  Â  padding: 40px 0;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .hero-title {
Â  Â  Â  Â  Â  Â  font-size: 2.5rem;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .scrollable-table {
Â  Â  Â  Â  Â  Â  max-height: 600px;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .roi-explainer {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .version-badge {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>


Â  Â  <button class="btn btn-outline-secondary theme-toggle" id="themeToggle">
Â  Â  Â  Â  <i class="bi bi-moon-stars-fill" id="themeIcon"></i>
Â  Â  </button>


Â  Â  <div class="container">
Â  Â  Â  Â  
Â  Â  Â  Â  <!-- Hero Section -->
Â  Â  Â  Â  <div class="hero-section">
Â  Â  Â  Â  Â  Â  <h1 class="hero-title">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="bi bi-graph-up-arrow"></i> SILVERMIC Trading Strategy
Â  Â  Â  Â  Â  Â  </h1>
Â  Â  Â  Â  Â  Â  <p><span class="version-badge">V2 - IMPROVED (BEST)</span></p>
Â  Â  Â  Â  Â  Â  <p class="lead">Dynamic Trailing SL â€¢ Dual REENTRY â€¢ Low Expenses</p>
Â  Â  Â  Â  Â  Â  <p class="text-muted" id="reportDate"></p>
Â  Â  Â  Â  </div>


Â  Â  Â  Â  <!-- ROI Explainer -->
Â  Â  Â  Â  <div class="roi-explainer">
Â  Â  Â  Â  Â  Â  <h5><i class="bi bi-info-circle-fill"></i> Understanding Your Returns</h5>
Â  Â  Â  Â  Â  Â  <div class="row mt-3">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ROI on Total Capital:</strong> Return on full â‚¹50,000 account<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small>Shows overall account growth percentage</small>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ROI on Invested Capital:</strong> Return on actual margin used<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small>Shows trading efficiency (profit per rupee risked)</small>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>


Â  Â  Â  Â  <!-- Summary Cards -->
Â  Â  Â  Â  <div class="row mb-4">
Â  Â  Â  Â  Â  Â  <div class="col-md-3">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Initial Capital</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-value" id="initialCapital">â‚¹0</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-md-3">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Final Capital</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-value" id="finalCapital">â‚¹0</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-md-3">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Net PnL</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-value" id="netPnl">â‚¹0</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-md-3">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">ROI (Capital)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-value" id="roi">0%</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>


Â  Â  Â  Â  <!-- ROI Breakdown -->
Â  Â  Â  Â  <div class="row mb-4">
Â  Â  Â  Â  Â  Â  <div class="col-md-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-body text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-muted">Total Margin Used</h6>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="totalMarginUsed">â‚¹0</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small class="text-muted">Sum of all margins</small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-md-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-body text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-muted">Avg Margin/Trade</h6>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="avgMargin">â‚¹0</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small class="text-muted">Per trade investment</small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-md-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-body text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-muted">ROI (Invested)</h6>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="profit-text" id="roiInvested">0%</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small class="text-muted">On actual money used</small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>


Â  Â  Â  Â  <!-- Performance Overview -->
Â  Â  Â  Â  <div class="row mb-4">
Â  Â  Â  Â  Â  Â  <div class="col-md-12">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header bg-primary text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h5 class="mb-0"><i class="bi bi-bar-chart-fill"></i> Performance Overview</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="row text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-muted">Total Trades</h6>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="totalTrades">0</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-muted">Winning Trades</h6>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="profit-text" id="winningTrades">0</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-muted">Losing Trades</h6>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="loss-text" id="losingTrades">0</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-muted">Win Rate</h6>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="winRate">0%</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-muted">Max Drawdown</h6>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="loss-text" id="maxDrawdown">0%</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-muted">Avg ROI/Trade</h6>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="avgRoi">0%</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>


Â  Â  Â  Â  <!-- PnL Breakdown -->
Â  Â  Â  Â  <div class="row mb-4">
Â  Â  Â  Â  Â  Â  <div class="col-md-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-body text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-muted">PnL Before Expenses</h6>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="pnlBeforeExpense">â‚¹0</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-md-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-body text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-muted">Total Expenses</h6>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="loss-text" id="totalExpenses">â‚¹0</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small class="text-muted" id="expenseDetails"></small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-md-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-body text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-muted">Biggest Win / Loss</h6>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="profit-text" id="biggestWin">â‚¹0</span> / 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="loss-text" id="biggestLoss">â‚¹0</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>


Â  Â  Â  Â  <!-- Strategy Performance -->
Â  Â  Â  Â  <div class="row mb-4">
Â  Â  Â  Â  Â  Â  <div class="col-md-12">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header bg-success text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h5 class="mb-0"><i class="bi bi-trophy-fill"></i> Strategy Performance</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-responsive">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="table table-hover">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Strategy</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Total Trades</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Wins</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Losses</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Win Rate</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Net PnL</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="strategyPerformanceTable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>


Â  Â  Â  Â  <!-- Monthly Performance -->
Â  Â  Â  Â  <div class="row mb-4">
Â  Â  Â  Â  Â  Â  <div class="col-md-12">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header bg-info text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h5 class="mb-0"><i class="bi bi-calendar3"></i> Monthly Performance</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-responsive scrollable-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="table table-hover">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="sticky-top bg-light">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Month</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Trades</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Wins</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Win %</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>PnL (Before Exp.)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Expenses</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Net PnL</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Best Strategy</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="monthlyStatsTable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>


Â  Â  Â  Â  <!-- All Trades -->
Â  Â  Â  Â  <div class="row mb-4">
Â  Â  Â  Â  Â  Â  <div class="col-md-12">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header bg-dark text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h5 class="mb-0"><i class="bi bi-list-ul"></i> All Trades</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" class="form-control" id="searchTrades" placeholder="ğŸ” Search trades...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="table-responsive scrollable-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="table table-striped table-hover">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="sticky-top">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>#</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Type</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Entry</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Exit</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Net PnL</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ROI %</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Exit Reason</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="allTradesTable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>


Â  Â  Â  Â  <!-- Footer -->
Â  Â  Â  Â  <footer class="text-center text-muted mt-5">
Â  Â  Â  Â  Â  Â  <p>Generated on <span id="generationTime"></span></p>
Â  Â  Â  Â  Â  Â  <p><small>SILVERMIC (1kg) V2 - IMPROVED Strategy | Best Performance</small></p>
Â  Â  Â  Â  </footer>


Â  Â  </div>


Â  Â  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
Â  Â  
Â  Â  <script>
Â  Â  Â  Â  const reportData = {{REPORT_DATA}};
Â  Â  Â  Â  
Â  Â  Â  Â  // Theme Toggle
Â  Â  Â  Â  const themeToggle = document.getElementById('themeToggle');
Â  Â  Â  Â  const themeIcon = document.getElementById('themeIcon');
Â  Â  Â  Â  const htmlElement = document.documentElement;
Â  Â  Â  Â  
Â  Â  Â  Â  themeToggle.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  const currentTheme = htmlElement.getAttribute('data-bs-theme');
Â  Â  Â  Â  Â  Â  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
Â  Â  Â  Â  Â  Â  htmlElement.setAttribute('data-bs-theme', newTheme);
Â  Â  Â  Â  Â  Â  themeIcon.classList.toggle('bi-moon-stars-fill');
Â  Â  Â  Â  Â  Â  themeIcon.classList.toggle('bi-sun-fill');
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  function formatCurrency(value) {
Â  Â  Â  Â  Â  Â  return 'â‚¹' + value.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function formatPercent(value) {
Â  Â  Â  Â  Â  Â  return value.toFixed(2) + '%';
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // Populate report date
Â  Â  Â  Â  document.getElementById('reportDate').textContent = `Generated: ${reportData.generation_time}`;
Â  Â  Â  Â  document.getElementById('initialCapital').textContent = formatCurrency(reportData.summary.initial_capital);
Â  Â  Â  Â  document.getElementById('finalCapital').textContent = formatCurrency(reportData.summary.final_capital);
Â  Â  Â  Â  
Â  Â  Â  Â  const netPnl = reportData.summary.net_pnl;
Â  Â  Â  Â  const netPnlElement = document.getElementById('netPnl');
Â  Â  Â  Â  netPnlElement.textContent = formatCurrency(netPnl);
Â  Â  Â  Â  netPnlElement.classList.add(netPnl >= 0 ? 'profit-text' : 'loss-text');
Â  Â  Â  Â  
Â  Â  Â  Â  const roi = reportData.summary.roi_on_capital;
Â  Â  Â  Â  const roiElement = document.getElementById('roi');
Â  Â  Â  Â  roiElement.textContent = formatPercent(roi);
Â  Â  Â  Â  roiElement.classList.add(roi >= 0 ? 'profit-text' : 'loss-text');
Â  Â  Â  Â  
Â  Â  Â  Â  // ROI Breakdown
Â  Â  Â  Â  document.getElementById('totalMarginUsed').textContent = formatCurrency(reportData.summary.total_margin_used || 0);
Â  Â  Â  Â  document.getElementById('avgMargin').textContent = formatCurrency(reportData.summary.avg_margin_per_trade || 0);
Â  Â  Â  Â  document.getElementById('roiInvested').textContent = formatPercent(reportData.summary.roi_on_invested || 0);
Â  Â  Â  Â  
Â  Â  Â  Â  // Performance
Â  Â  Â  Â  document.getElementById('totalTrades').textContent = reportData.summary.total_trades;
Â  Â  Â  Â  document.getElementById('winningTrades').textContent = reportData.summary.winning_trades;
Â  Â  Â  Â  document.getElementById('losingTrades').textContent = reportData.summary.losing_trades;
Â  Â  Â  Â  document.getElementById('winRate').textContent = formatPercent(reportData.summary.win_rate);
Â  Â  Â  Â  document.getElementById('maxDrawdown').textContent = formatPercent(reportData.summary.max_drawdown);
Â  Â  Â  Â  document.getElementById('avgRoi').textContent = formatPercent(reportData.summary.avg_roi_per_trade);
Â  Â  Â  Â  
Â  Â  Â  Â  // PnL
Â  Â  Â  Â  document.getElementById('pnlBeforeExpense').textContent = formatCurrency(reportData.summary.total_pnl_before_expense);
Â  Â  Â  Â  document.getElementById('totalExpenses').textContent = formatCurrency(reportData.summary.total_expenses);
Â  Â  Â  Â  document.getElementById('expenseDetails').textContent = `(${reportData.summary.total_trades} trades Ã— â‚¹${reportData.config.expense_per_trade})`;
Â  Â  Â  Â  document.getElementById('biggestWin').textContent = formatCurrency(reportData.summary.biggest_win);
Â  Â  Â  Â  document.getElementById('biggestLoss').textContent = formatCurrency(reportData.summary.biggest_loss);
Â  Â  Â  Â  
Â  Â  Â  Â  // Strategy Performance
Â  Â  Â  Â  const strategyTable = document.getElementById('strategyPerformanceTable');
Â  Â  Â  Â  const strategies = ['PRIMARY', 'SECONDARY', 'REENTRY-1', 'REENTRY-2', 'SHORT'];
Â  Â  Â  Â  
Â  Â  Â  Â  strategies.forEach(strategy => {
Â  Â  Â  Â  Â  Â  const data = reportData.strategy_performance[strategy];
Â  Â  Â  Â  Â  Â  if (data && data.trades > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const row = document.createElement('tr');
Â  Â  Â  Â  Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="badge bg-primary">${strategy}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${data.trades}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="profit-text">${data.wins}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="loss-text">${data.losses}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatPercent(data.win_rate)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="${data.pnl >= 0 ? 'profit-text' : 'loss-text'}"><strong>${formatCurrency(data.pnl)}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  strategyTable.appendChild(row);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  // Monthly Stats
Â  Â  Â  Â  const monthlyTable = document.getElementById('monthlyStatsTable');
Â  Â  Â  Â  const sortedMonths = Object.keys(reportData.monthly_stats || {}).sort();
Â  Â  Â  Â  
Â  Â  Â  Â  sortedMonths.forEach(monthKey => {
Â  Â  Â  Â  Â  Â  const month = reportData.monthly_stats[monthKey];
Â  Â  Â  Â  Â  Â  let bestStrategy = 'N/A';
Â  Â  Â  Â  Â  Â  let maxWins = 0;
Â  Â  Â  Â  Â  Â  ['primary', 'secondary', 'reentry1', 'reentry2', 'short'].forEach(s => {
Â  Â  Â  Â  Â  Â  Â  Â  const wins = month[s + '_wins'] || 0;
Â  Â  Â  Â  Â  Â  Â  Â  if (wins > maxWins) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bestStrategy = s.toUpperCase().replace('REENTRY1', 'REENTRY-1').replace('REENTRY2', 'REENTRY-2');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  maxWins = wins;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const row = document.createElement('tr');
Â  Â  Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <td><strong>${month.month_name}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${month.total_trades}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="profit-text">${month.winning_trades}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatPercent(month.win_rate)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatCurrency(month.pnl_before_expense)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="loss-text">${formatCurrency(month.expenses)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="${month.net_pnl >= 0 ? 'profit-text' : 'loss-text'}"><strong>${formatCurrency(month.net_pnl)}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="badge bg-success">${bestStrategy}</span></td>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  monthlyTable.appendChild(row);
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  // All Trades
Â  Â  Â  Â  const allTradesTable = document.getElementById('allTradesTable');
Â  Â  Â  Â  reportData.trades.forEach(trade => {
Â  Â  Â  Â  Â  Â  const statusBadge = trade.pnl_before_expense >= 0 ? 
Â  Â  Â  Â  Â  Â  Â  Â  '<span class="badge badge-profit">WIN</span>' : 
Â  Â  Â  Â  Â  Â  Â  Â  '<span class="badge badge-loss">LOSS</span>';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const typeBadge = {
Â  Â  Â  Â  Â  Â  Â  Â  'PRIMARY': 'bg-primary',
Â  Â  Â  Â  Â  Â  Â  Â  'SECONDARY': 'bg-info',
Â  Â  Â  Â  Â  Â  Â  Â  'REENTRY-1': 'bg-warning text-dark',
Â  Â  Â  Â  Â  Â  Â  Â  'REENTRY-2': 'bg-warning text-dark',
Â  Â  Â  Â  Â  Â  Â  Â  'SHORT': 'bg-danger'
Â  Â  Â  Â  Â  Â  }[trade.type] || 'bg-secondary';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const row = document.createElement('tr');
Â  Â  Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <td>${trade.trade_number}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${trade.exit_date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="badge ${typeBadge}">${trade.type}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatCurrency(trade.entry)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${formatCurrency(trade.exit)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="${trade.total_pnl >= 0 ? 'profit-text' : 'loss-text'}"><strong>${formatCurrency(trade.total_pnl)}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="${trade.roi >= 0 ? 'profit-text' : 'loss-text'}">${formatPercent(trade.roi)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><small>${trade.exit_reason}</small></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${statusBadge}</td>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  allTradesTable.appendChild(row);
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  // Search
Â  Â  Â  Â  document.getElementById('searchTrades').addEventListener('keyup', function() {
Â  Â  Â  Â  Â  Â  const searchTerm = this.value.toLowerCase();
Â  Â  Â  Â  Â  Â  const rows = allTradesTable.getElementsByTagName('tr');
Â  Â  Â  Â  Â  Â  for (let row of rows) {
Â  Â  Â  Â  Â  Â  Â  Â  row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  document.getElementById('generationTime').textContent = reportData.generation_time;
Â  Â  </script>
</body>
</html>

what things are mising.

1. the correctt dates as entry date and exit date.
2. tradewize profit and loss. like buy = pnl 0 sold pnl +100 etc.
3. an comprehensive dyunamic chart with all the trades with arrows on the chart. if you can use and show the data then pls use tradingview lightweight charts https://github.com/tradingview/lightweight-charts and show all the trades on the cahrt with arrows so i can visually see and understand. create seperate file for the chart.
4. also add an seperate mplotlib cahrt in the backtest_report.html so i can interct with the chart and see when andwhere we bought and shwen and where we sold. 

hyper detaield repoert. pls give me updated compelte code so i can achive this..

1. first tell me what you have understood and what you will give me and start with signle steps. 1 file code at a time.